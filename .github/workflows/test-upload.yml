name: Test File Upload

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Test scenario to run'
        required: true
        default: 'single-file'
        type: choice
        options:
          - single-file
          - multiple-files
          - directory
          - wildcard-patterns
          - large-files
      obs_bucket:
        description: 'OBS bucket name for testing'
        required: false
        type: string
      obs_region:
        description: 'OBS region'
        required: false
        default: 'cn-north-4'
        type: string

env:
  OBS_BUCKET: ${{ inputs.obs_bucket || secrets.OBS_BUCKET }}
  OBS_KEY_ID: ${{ secrets.OBS_KEY_ID }}
  OBS_KEY_SECRET: ${{ secrets.OBS_KEY_SECRET }}
  OBS_REGION: ${{ inputs.obs_region || 'cn-north-4' }}

jobs:
  test-upload:
    runs-on: ubuntu-latest
    name: Test Upload - ${{ inputs.test_scenario }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          # Make script executable and run it
          chmod +x generate-test-files.sh
          ./generate-test-files.sh

      - name: Test Single File Upload
        if: inputs.test_scenario == 'single-file'
        uses: ./
        with:
          access_key: ${{ env.OBS_KEY_ID }}
          secret_key: ${{ env.OBS_KEY_SECRET }}
          region: ${{ env.OBS_REGION }}
          bucket_name: ${{ env.OBS_BUCKET }}
          operation: upload
          source: test-files/simple.txt
          destination: test-uploads/single/
          progress: true
          dry_run: false

      - name: Test Multiple Files Upload
        if: inputs.test_scenario == 'multiple-files'
        uses: ./
        with:
          access_key: ${{ env.OBS_KEY_ID }}
          secret_key: ${{ env.OBS_KEY_SECRET }}
          region: ${{ env.OBS_REGION }}
          bucket_name: ${{ env.OBS_BUCKET }}
          operation: upload
          source: test-files/documents/doc1.txt,test-files/documents/doc2.txt,test-files/images/image1.jpg
          destination: test-uploads/multiple/
          progress: true
          concurrency: 3

      - name: Test Directory Upload
        if: inputs.test_scenario == 'directory'
        uses: ./
        with:
          access_key: ${{ env.OBS_KEY_ID }}
          secret_key: ${{ env.OBS_KEY_SECRET }}
          region: ${{ env.OBS_REGION }}
          bucket_name: ${{ env.OBS_BUCKET }}
          operation: upload
          source: test-files/
          destination: test-uploads/directory/
          preserve_structure: true
          progress: true
          concurrency: 5

      - name: Test Wildcard Patterns Upload
        if: inputs.test_scenario == 'wildcard-patterns'
        uses: ./
        with:
          access_key: ${{ env.OBS_KEY_ID }}
          secret_key: ${{ env.OBS_KEY_SECRET }}
          region: ${{ env.OBS_REGION }}
          bucket_name: ${{ env.OBS_BUCKET }}
          operation: upload
          source: test-files/**/*.txt
          destination: test-uploads/wildcard/
          exclude: "*.bin,*large*"
          preserve_structure: true
          progress: true

      - name: Test Large Files Upload
        if: inputs.test_scenario == 'large-files'
        uses: ./
        with:
          access_key: ${{ env.OBS_KEY_ID }}
          secret_key: ${{ env.OBS_KEY_SECRET }}
          region: ${{ env.OBS_REGION }}
          bucket_name: ${{ env.OBS_BUCKET }}
          operation: upload
          source: test-files/large-file.bin
          destination: test-uploads/large/
          progress: true
          checksum_validation: true
          storage_class: STANDARD
          retry_count: 5

      - name: Verify Upload Results
        run: |
          echo "Upload test completed for scenario: ${{ inputs.test_scenario }}"
          echo "Check the action outputs and OBS bucket for uploaded files"

      - name: Cleanup Test Files
        if: always()
        run: |
          rm -rf test-files/
          echo "Test files cleaned up"
